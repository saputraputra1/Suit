<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suit Game Multiplayer Premium+</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --danger: #f72585;
            --success: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            overflow-x: hidden;
        }
        
        .container {
            text-align: center;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
            width: 95%;
            max-width: 600px;
            margin: 1rem;
            transition: var(--transition);
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 2rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        
        .game-section {
            margin-bottom: 2rem;
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .input-group {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        input {
            padding: 0.8rem 1rem;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            font-size: 1rem;
            transition: var(--transition);
            width: 100%;
        }
        
        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.2);
        }
        
        .btn {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .btn-secondary {
            background-color: var(--light);
            color: var(--dark);
            border: 1px solid #dee2e6;
        }
        
        .btn-secondary:hover {
            background-color: #e9ecef;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d91a6d;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .players-container {
            display: flex;
            justify-content: space-around;
            margin: 2rem 0;
            gap: 1rem;
        }
        
        .player-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            width: 100%;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .player-card.active {
            border: 3px solid var(--accent);
        }
        
        .player-card.winner {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 201, 240, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(76, 201, 240, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 201, 240, 0); }
        }
        
        .player-name {
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }
        
        .player-choice {
            font-size: 4rem;
            margin: 1rem 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .player-choice.hidden-choice {
            filter: blur(10px);
            opacity: 0.7;
        }
        
        .player-score {
            font-size: 1.1rem;
            color: var(--primary);
            font-weight: 600;
        }
        
        .choices {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }
        
        .choice {
            font-size: 3.5rem;
            cursor: pointer;
            padding: 1.5rem;
            border-radius: 50%;
            background: white;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: 3px solid transparent;
        }
        
        .choice:hover {
            transform: scale(1.1) translateY(-5px);
            background: var(--light);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .choice.selected {
            transform: scale(1.1);
            border-color: var(--accent);
            background: #e3f2fd;
        }
        
        .choice:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .game-status {
            font-weight: 700;
            margin: 1.5rem 0;
            font-size: 1.3rem;
            min-height: 2rem;
            color: var(--primary);
            animation: fadeIn 0.5s ease-out;
        }
        
        .round-info {
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--secondary);
        }
        
        .hidden {
            display: none;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }
        
        .player-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .player-item {
            background: #f1f3f5;
            padding: 0.7rem 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.7rem;
        }
        
        .player-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .room-id-display {
            background: #e9ecef;
            padding: 0.8rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.2rem;
            margin: 1rem 0;
            display: inline-block;
        }
        
        .copy-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: 0.5rem;
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: var(--accent);
            opacity: 0;
            z-index: 9999;
            animation: confetti 5s ease-out;
        }
        
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        
        .emoji-reaction {
            position: absolute;
            font-size: 2rem;
            animation: floatUp 2s ease-out forwards;
            z-index: 10;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(0.5); opacity: 0; }
        }
        
        /* New styles for additional features */
        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
            cursor: pointer;
            margin: 10px auto;
            display: block;
        }
        
        .profile-upload {
            display: none;
        }
        
        .tournament-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .tournament-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .tournament-level {
            font-weight: bold;
            color: var(--primary);
        }
        
        .leaderboard {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .leaderboard th, .leaderboard td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .leaderboard th {
            background-color: var(--primary);
            color: white;
        }
        
        .leaderboard tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .rank-badge {
            display: inline-block;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: gold;
            color: black;
            text-align: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 100;
        }
        
        .rematch-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .rematch-request {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        
        .rematch-pending {
            display: inline-block;
            margin-left: 10px;
            animation: pulse 1.5s infinite;
        }
        
        .player-level {
            font-size: 0.9rem;
            color: var(--secondary);
            margin-top: 5px;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 1.5rem;
            }
            
            .players-container {
                flex-direction: column;
            }
            
            .choice {
                font-size: 3rem;
                width: 80px;
                height: 80px;
                padding: 1rem;
            }
            
            .player-choice {
                font-size: 3.5rem;
                min-height: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Batu Gunting Kertas Premium+ üéÆ</h1>
        
        <!-- Game Setup Screen -->
        <div id="gameSetup" class="game-section">
            <div class="input-group">
                <label for="playerName">Nama Pemain</label>
                <input type="text" id="playerName" placeholder="Masukkan nama Anda" required>
            </div>
            
            <div class="input-group" style="text-align: center;">
                <label>Foto Profil</label>
                <img id="profilePreview" src="https://via.placeholder.com/80" class="profile-pic" onclick="document.getElementById('profileUpload').click()">
                <input type="file" id="profileUpload" class="profile-upload" accept="image/*">
            </div>
            
            <div class="input-group">
                <label for="roomId">ID Room (kosongkan untuk buat room baru)</label>
                <input type="text" id="roomId" placeholder="Masukkan ID room">
            </div>
            
            <button id="joinRoom" class="btn btn-primary">
                <span>üéÆ</span> Gabung Room
            </button>
            
            <button id="showTournaments" class="btn btn-secondary" style="margin-top: 10px;">
                <span>üèÜ</span> Turnamen
            </button>
            
            <button id="showLeaderboard" class="btn btn-secondary" style="margin-top: 10px;">
                <span>üìä</span> Peringkat
            </button>
        </div>
        
        <!-- Tournament Screen -->
        <div id="tournamentScreen" class="game-section hidden">
            <h2>Pilih Turnamen</h2>
            <div id="tournamentList"></div>
            <button id="backToMain" class="btn btn-secondary" style="margin-top: 20px;">
                <span>‚¨ÖÔ∏è</span> Kembali
            </button>
        </div>
        
        <!-- Waiting Room Screen -->
        <div id="waitingRoom" class="game-section hidden">
            <h2>Menunggu Pemain Lain...</h2>
            <p>Bagikan ID Room ini ke teman Anda:</p>
            <div class="room-id-display">
                <span id="displayRoomId"></span>
                <button class="copy-btn" onclick="copyRoomId()">‚éò</button>
            </div>
            
            <div class="player-list" id="playerList"></div>
            
            <div id="waitingMessage" class="game-status">
                Menunggu pemain kedua bergabung...
            </div>
            
            <button id="startGame" class="btn btn-primary" disabled>
                <span>üöÄ</span> Mulai Game
            </button>
            
            <button id="cancelGame" class="btn btn-secondary" style="margin-top: 1rem;">
                <span>‚ùå</span> Batalkan
            </button>
        </div>
        
        <!-- Game Area Screen -->
        <div id="gameArea" class="game-section hidden">
            <div class="round-info">
                Ronde <span id="currentRound">1</span> dari <span id="maxRounds">3</span>
            </div>
            
            <div class="players-container">
                <div class="player-card" id="player1Card">
                    <div class="player-name" id="player1Name">Pemain 1</div>
                    <div class="player-level" id="player1Level">Level 1</div>
                    <div class="player-choice" id="player1Choice">‚ùì</div>
                    <div class="player-score" id="player1Score">Skor: 0</div>
                </div>
                <div class="player-card" id="player2Card">
                    <div class="player-name" id="player2Name">Pemain 2</div>
                    <div class="player-level" id="player2Level">Level 1</div>
                    <div class="player-choice hidden-choice" id="player2Choice">‚ùì</div>
                    <div class="player-score" id="player2Score">Skor: 0</div>
                </div>
            </div>
            
            <div id="gameStatus" class="game-status">
                Pilih batu, gunting, atau kertas!
            </div>
            
            <div class="choices">
                <div class="choice" data-choice="‚úä" title="Batu">‚úä</div>
                <div class="choice" data-choice="‚úåÔ∏è" title="Gunting">‚úåÔ∏è</div>
                <div class="choice" data-choice="‚úã" title="Kertas">‚úã</div>
            </div>
            
            <div id="rematchSection" class="hidden" style="margin-top: 2rem;">
                <button id="rematchButton" class="btn btn-primary">
                    <span>üîÑ</span> Main Lagi
                </button>
                <button id="quitGame" class="btn btn-secondary" style="margin-left: 1rem;">
                    <span>üö™</span> Keluar
                </button>
            </div>
            
            <div id="rematchRequest" class="rematch-request">
                <p id="rematchText">Lawan meminta rematch!</p>
                <button id="acceptRematch" class="btn btn-primary">
                    <span>üëç</span> Terima
                </button>
                <button id="declineRematch" class="btn btn-secondary" style="margin-left: 1rem;">
                    <span>üëé</span> Tolak
                </button>
            </div>
        </div>
        
        <!-- Game Result Screen -->
        <div id="gameResult" class="game-section hidden">
            <h2 id="resultText" style="margin-bottom: 1.5rem;"></h2>
            
            <div class="players-container" style="margin-bottom: 2rem;">
                <div class="player-card" id="finalPlayer1Card">
                    <div class="player-name" id="finalPlayer1Name">Pemain 1</div>
                    <div class="player-level" id="finalPlayer1Level">Level 1</div>
                    <div class="player-score" id="finalPlayer1Score">Skor: 0</div>
                </div>
                <div class="player-card" id="finalPlayer2Card">
                    <div class="player-name" id="finalPlayer2Name">Pemain 2</div>
                    <div class="player-level" id="finalPlayer2Level">Level 1</div>
                    <div class="player-score" id="finalPlayer2Score">Skor: 0</div>
                </div>
            </div>
            
            <button id="newGameButton" class="btn btn-primary">
                <span>üéÆ</span> Buat Game Baru
            </button>
            
            <button id="viewLeaderboard" class="btn btn-secondary" style="margin-top: 1rem;">
                <span>üìä</span> Lihat Peringkat
            </button>
        </div>
        
        <!-- Leaderboard Screen -->
        <div id="leaderboardScreen" class="game-section hidden">
            <h2>üèÜ Peringkat Pemain</h2>
            <table class="leaderboard">
                <thead>
                    <tr>
                        <th>Peringkat</th>
                        <th>Nama</th>
                        <th>Level</th>
                        <th>Skor</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                </tbody>
            </table>
            <button id="backFromLeaderboard" class="btn btn-primary" style="margin-top: 20px;">
                <span>‚¨ÖÔ∏è</span> Kembali
            </button>
        </div>
    </div>

    <div class="sound-toggle" id="soundToggle">üîä</div>

    <script>
        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCixqJ_eDJ0vscvsI_Z1Th10FEfKi0hdx8",
            authDomain: "suit-game-multiplayer.firebaseapp.com",
            databaseURL: "https://suit-game-multiplayer-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "suit-game-multiplayer",
            storageBucket: "suit-game-multiplayer.appspot.com",
            messagingSenderId: "952401204408",
            appId: "1:952401204408:web:9f80216aa84b30663c904d"
        };
        
        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Elemen UI
        const gameSetup = document.getElementById('gameSetup');
        const waitingRoom = document.getElementById('waitingRoom');
        const gameArea = document.getElementById('gameArea');
        const gameResult = document.getElementById('gameResult');
        const tournamentScreen = document.getElementById('tournamentScreen');
        const leaderboardScreen = document.getElementById('leaderboardScreen');
        
        const playerNameInput = document.getElementById('playerName');
        const roomIdInput = document.getElementById('roomId');
        const joinRoomBtn = document.getElementById('joinRoom');
        const displayRoomId = document.getElementById('displayRoomId');
        const playerList = document.getElementById('playerList');
        const startGameBtn = document.getElementById('startGame');
        const cancelGameBtn = document.getElementById('cancelGame');
        
        const player1Card = document.getElementById('player1Card');
        const player2Card = document.getElementById('player2Card');
        const player1Name = document.getElementById('player1Name');
        const player2Name = document.getElementById('player2Name');
        const player1Level = document.getElementById('player1Level');
        const player2Level = document.getElementById('player2Level');
        const player1Choice = document.getElementById('player1Choice');
        const player2Choice = document.getElementById('player2Choice');
        const player1Score = document.getElementById('player1Score');
        const player2Score = document.getElementById('player2Score');
        const gameStatus = document.getElementById('gameStatus');
        const choices = document.querySelectorAll('.choice');
        const rematchButton = document.getElementById('rematchButton');
        const quitGameBtn = document.getElementById('quitGame');
        const rematchSection = document.getElementById('rematchSection');
        const rematchRequest = document.getElementById('rematchRequest');
        const rematchText = document.getElementById('rematchText');
        const acceptRematch = document.getElementById('acceptRematch');
        const declineRematch = document.getElementById('declineRematch');
        const resultText = document.getElementById('resultText');
        const newGameButton = document.getElementById('newGameButton');
        const currentRoundEl = document.getElementById('currentRound');
        const maxRoundsEl = document.getElementById('maxRounds');
        const waitingMessage = document.getElementById('waitingMessage');
        const showTournamentsBtn = document.getElementById('showTournaments');
        const showLeaderboardBtn = document.getElementById('showLeaderboard');
        const viewLeaderboardBtn = document.getElementById('viewLeaderboard');
        const backToMainBtn = document.getElementById('backToMain');
        const backFromLeaderboardBtn = document.getElementById('backFromLeaderboard');
        const tournamentList = document.getElementById('tournamentList');
        const leaderboardBody = document.getElementById('leaderboardBody');
        const soundToggle = document.getElementById('soundToggle');
        const profilePreview = document.getElementById('profilePreview');
        const profileUpload = document.getElementById('profileUpload');
        
        // Variabel game state
        let playerId;
        let roomId;
        let playerNames = {};
        let playerChoices = {};
        let playerScores = {};
        let isHost = false;
        let gameStarted = false;
        let currentRound = 0;
        let maxRounds = 3;
        let roomRef;
        let playerIds = [];
        let playerProfilePic = "https://via.placeholder.com/80";
        let playerStats = {
            level: 1,
            xp: 0,
            totalWins: 0,
            totalMatches: 0
        };
        let soundEnabled = true;
        let currentTournament = null;
        let tournamentData = [];
        let rematchRequested = false;
        let opponentRematchStatus = false;
        
        // Create audio elements
        const sounds = {
            click: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3'),
            win: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'),
            lose: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-retro-arcade-lose-2027.mp3'),
            draw: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-neutral-game-notification-933.mp3'),
            background: new Audio('https://assets.mixkit.co/music/preview/mixkit-game-show-suspense-waiting-668.mp3')
        };
        
        // Initialize tournaments
        function initTournaments() {
            for (let i = 1; i <= 20; i++) {
                tournamentData.push({
                    id: `tournament_${i}`,
                    name: `Turnamen Level ${i}`,
                    level: i,
                    requiredXP: i * 1000,
                    prize: `${i * 500} XP`,
                    participants: Math.floor(Math.random() * 100) + 10
                });
            }
        }
        
        // Play sound function
        function playSound(type) {
            if (!soundEnabled) return;
            
            sounds[type].currentTime = 0;
            sounds[type].play().catch(e => console.log("Audio play failed:", e));
        }
        
        // Event listeners
        joinRoomBtn.addEventListener('click', joinRoom);
        startGameBtn.addEventListener('click', startGame);
        cancelGameBtn.addEventListener('click', cancelGame);
        choices.forEach(choice => {
            choice.addEventListener('click', makeChoice);
        });
        rematchButton.addEventListener('click', requestRematch);
        quitGameBtn.addEventListener('click', quitGame);
        newGameButton.addEventListener('click', resetGame);
        showTournamentsBtn.addEventListener('click', showTournaments);
        showLeaderboardBtn.addEventListener('click', showLeaderboard);
        viewLeaderboardBtn.addEventListener('click', showLeaderboard);
        backToMainBtn.addEventListener('click', backToMain);
        backFromLeaderboardBtn.addEventListener('click', backFromLeaderboard);
        acceptRematch.addEventListener('click', acceptRematchRequest);
        declineRematch.addEventListener('click', declineRematchRequest);
        soundToggle.addEventListener('click', toggleSound);
        profileUpload.addEventListener('change', handleProfileUpload);
        
        // Fungsi untuk bergabung ke room
        function joinRoom() {
            const name = playerNameInput.value.trim();
            if (!name) {
                showError('Masukkan nama Anda!');
                return;
            }
            
            if (name.length > 15) {
                showError('Nama maksimal 15 karakter');
                return;
            }
            
            playerId = generateId();
            roomId = roomIdInput.value.trim() || generateId();
            
            // Simpan nama pemain
            playerNames[playerId] = name;
            playerScores[playerId] = 0;
            
            // Gabung ke room
            roomRef = database.ref(`rooms/${roomId}`);
            
            // Cek apakah room sudah ada
            roomRef.once('value').then(snapshot => {
                const roomData = snapshot.val();
                
                if (roomData && roomData.players) {
                    // Room sudah ada, gabung sebagai player 2
                    if (Object.keys(roomData.players).length >= 2) {
                        showError('Room sudah penuh! Maksimal 2 pemain.');
                        return;
                    }
                    
                    isHost = false;
                    joinExistingRoom(roomRef, roomData);
                } else {
                    // Buat room baru
                    isHost = true;
                    createNewRoom(roomRef);
                }
                
                // Update UI
                gameSetup.classList.add('hidden');
                waitingRoom.classList.remove('hidden');
                displayRoomId.textContent = roomId;
                
                // Jika host, aktifkan tombol start game ketika ada 2 pemain
                if (isHost) {
                    roomRef.child('players').on('value', playersSnapshot => {
                        const players = playersSnapshot.val() || {};
                        playerIds = Object.keys(players);
                        
                        if (playerIds.length === 2) {
                            startGameBtn.disabled = false;
                            waitingMessage.textContent = "Pemain sudah lengkap! Klik 'Mulai Game' untuk memulai.";
                        } else {
                            startGameBtn.disabled = true;
                            waitingMessage.textContent = "Menunggu pemain kedua bergabung...";
                        }
                        
                        updatePlayerList(players);
                    });
                } else {
                    updatePlayerList(roomData.players);
                }
            }).catch(error => {
                showError('Gagal terhubung ke server: ' + error.message);
            });
        }
        
        // Fungsi untuk membuat room baru
        function createNewRoom(roomRef) {
            roomRef.set({
                players: {
                    [playerId]: {
                        name: playerNames[playerId],
                        profilePic: playerProfilePic,
                        score: 0,
                        choice: null,
                        ready: false,
                        level: playerStats.level,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }
                },
                gameState: 'waiting',
                currentRound: 0,
                maxRounds: maxRounds,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                rematchRequested: false,
                rematchAccepted: false
            });
            
            // Listen for game state changes
            roomRef.child('gameState').on('value', snapshot => {
                const state = snapshot.val();
                if (state === 'playing') {
                    startGameUI();
                } else if (state === 'finished') {
                    showGameResult();
                }
            });
            
            // Listen for rematch requests
            setupRematchListener();
        }
        
        // Fungsi untuk gabung ke room yang sudah ada
        function joinExistingRoom(roomRef, roomData) {
            roomRef.child(`players/${playerId}`).set({
                name: playerNames[playerId],
                profilePic: playerProfilePic,
                score: 0,
                choice: null,
                ready: false,
                level: playerStats.level,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Set maxRounds sesuai room yang sudah ada
            maxRounds = roomData.maxRounds || maxRounds;
            
            // Listen for game state changes
            roomRef.child('gameState').on('value', snapshot => {
                const state = snapshot.val();
                if (state === 'playing') {
                    startGameUI();
                } else if (state === 'finished') {
                    showGameResult();
                }
            });
            
            // Listen for rematch requests
            setupRematchListener();
        }
        
        // Set up rematch listener
        function setupRematchListener() {
            roomRef.child('rematchRequested').on('value', snapshot => {
                const requested = snapshot.val();
                if (requested && !rematchRequested) {
                    // Opponent requested rematch
                    const opponentId = playerIds.find(id => id !== playerId);
                    rematchText.textContent = `${playerNames[opponentId]} ingin main lagi!`;
                    rematchRequest.style.display = 'block';
                    playSound('click');
                }
            });
            
            roomRef.child('rematchAccepted').on('value', snapshot => {
                const accepted = snapshot.val();
                if (accepted && rematchRequested) {
                    // Both players accepted rematch - start new game
                    startRematch();
                }
            });
        }
        
        // Fungsi untuk memulai game
        function startGame() {
            if (!isHost) return;
            
            playSound('click');
            roomRef.update({
                gameState: 'playing',
                currentRound: 1
            });
        }
        
        // Fungsi untuk membatalkan game
        function cancelGame() {
            playSound('click');
            if (isHost) {
                // Host membatalkan room
                roomRef.remove().then(() => {
                    resetGame();
                });
            } else {
                // Player keluar dari room
                roomRef.child(`players/${playerId}`).remove().then(() => {
                    resetGame();
                });
            }
        }
        
        // Fungsi untuk update UI saat game dimulai
        function startGameUI() {
            gameStarted = true;
            waitingRoom.classList.add('hidden');
            gameArea.classList.remove('hidden');
            
            // Update round info
            currentRoundEl.textContent = '1';
            maxRoundsEl.textContent = maxRounds;
            
            // Update player info
            roomRef.child('players').on('value', snapshot => {
                const players = snapshot.val();
                playerIds = Object.keys(players);
                
                // Update player names, levels and scores
                player1Name.textContent = players[playerIds[0]].name;
                player2Name.textContent = players[playerIds[1]].name;
                
                player1Level.textContent = `Level ${players[playerIds[0]].level || 1}`;
                player2Level.textContent = `Level ${players[playerIds[1]].level || 1}`;
                
                player1Score.textContent = `Skor: ${players[playerIds[0]].score}`;
                player2Score.textContent = `Skor: ${players[playerIds[1]].score}`;
                
                // Highlight active player
                player1Card.classList.remove('active');
                player2Card.classList.remove('active');
                if (playerId === playerIds[0]) {
                    player1Card.classList.add('active');
                } else {
                    player2Card.classList.add('active');
                }
                
                // Update choices
                const myChoice = players[playerId].choice;
                const opponentChoice = playerIds[0] === playerId ? players[playerIds[1]].choice : players[playerIds[0]].choice;
                
                if (myChoice) {
                    player1Choice.textContent = playerIds[0] === playerId ? myChoice : '‚ùì';
                    player2Choice.textContent = playerIds[1] === playerId ? myChoice : '‚ùì';
                    
                    // Show opponent choice only when both have chosen
                    if (players[playerIds[0]].choice && players[playerIds[1]].choice) {
                        player1Choice.textContent = players[playerIds[0]].choice;
                        player2Choice.textContent = players[playerIds[1]].choice;
                        player2Choice.classList.remove('hidden-choice');
                    } else {
                        player2Choice.classList.add('hidden-choice');
                    }
                } else {
                    player1Choice.textContent = '‚ùì';
                    player2Choice.textContent = '‚ùì';
                    player2Choice.classList.add('hidden-choice');
                }
                
                // Check if both players have made choices
                if (players[playerIds[0]].choice && players[playerIds[1]].choice) {
                    determineRoundWinner(players);
                }
            });
            
            // Listen for round changes
            roomRef.child('currentRound').on('value', snapshot => {
                const round = snapshot.val();
                currentRound = round;
                currentRoundEl.textContent = round;
            });
        }
        
        // Fungsi untuk membuat pilihan
        function makeChoice(e) {
            if (!gameStarted) return;
            
            const choice = e.currentTarget.getAttribute('data-choice');
            
            // Animasi pilihan
            choices.forEach(c => {
                c.classList.remove('selected');
                c.style.pointerEvents = 'none';
            });
            e.currentTarget.classList.add('selected');
            
            // Animasi shake
            player1Choice.classList.add('shake');
            player2Choice.classList.add('shake');
            setTimeout(() => {
                player1Choice.classList.remove('shake');
                player2Choice.classList.remove('shake');
            }, 500);
            
            // Update ke database
            roomRef.child(`players/${playerId}`).update({
                choice: choice,
                ready: true
            });
            
            // Tampilkan emoji reaksi
            showReaction(choice);
            playSound('click');
        }
        
        // Fungsi untuk menampilkan emoji reaksi
        function showReaction(choice) {
            const reactions = {
                '‚úä': ['üí™', 'üëä', 'ü™®'],
                '‚úåÔ∏è': ['‚úÇÔ∏è', 'ü§û', '‚úåÔ∏è'],
                '‚úã': ['üìÑ', 'üëã', 'üñêÔ∏è']
            };
            
            const randomReaction = reactions[choice][Math.floor(Math.random() * reactions[choice].length)];
            const reactionEl = document.createElement('div');
            reactionEl.className = 'emoji-reaction';
            reactionEl.textContent = randomReaction;
            reactionEl.style.left = `${Math.random() * 80 + 10}%`;
            
            document.body.appendChild(reactionEl);
            setTimeout(() => {
                reactionEl.remove();
            }, 2000);
        }
        
        // Fungsi untuk menentukan pemenang ronde
        function determineRoundWinner(players) {
            const choice1 = players[playerIds[0]].choice;
            const choice2 = players[playerIds[1]].choice;
            
            let result;
            let winnerId = null;
            
            if (choice1 === choice2) {
                result = "Seri!";
                playSound('draw');
                
                // Add XP for both players in a draw
                playerStats.xp += 200;
                updatePlayerStats();
            } else if (
                (choice1 === "‚úä" && choice2 === "‚úåÔ∏è") ||
                (choice1 === "‚úåÔ∏è" && choice2 === "‚úã") ||
                (choice1 === "‚úã" && choice2 === "‚úä")
            ) {
                result = `${players[playerIds[0]].name} Menang!`;
                winnerId = playerIds[0];
                playerScores[playerIds[0]]++;
                
                if (winnerId === playerId) {
                    playSound('win');
                    playerStats.xp += 500;
                    playerStats.totalWins++;
                } else {
                    playSound('lose');
                    playerStats.xp += 100;
                }
                
                updatePlayerStats();
            } else {
                result = `${players[playerIds[1]].name} Menang!`;
                winnerId = playerIds[1];
                playerScores[playerIds[1]]++;
                
                if (winnerId === playerId) {
                    playSound('win');
                    playerStats.xp += 500;
                    playerStats.totalWins++;
                } else {
                    playSound('lose');
                    playerStats.xp += 100;
                }
                
                updatePlayerStats();
            }
            
            playerStats.totalMatches++;
            
            // Check for level up
            const neededXP = playerStats.level * 1000;
            if (playerStats.xp >= neededXP) {
                playerStats.level++;
                playerStats.xp = playerStats.xp - neededXP;
                alert(`Level Up! Sekarang level ${playerStats.level}`);
                
                // Update level in Firebase
                if (roomRef) {
                    roomRef.child(`players/${playerId}/level`).set(playerStats.level);
                }
            }
            
            // Animasi hasil
            gameStatus.textContent = result;
            gameStatus.classList.add('fade-in');
            setTimeout(() => gameStatus.classList.remove('fade-in'), 500);
            
            if (winnerId) {
                const winnerCard = winnerId === playerIds[0] ? player1Card : player2Card;
                winnerCard.classList.add('winner');
                setTimeout(() => winnerCard.classList.remove('winner'), 1500);
                
                // Tampilkan confetti untuk pemenang
                if (winnerId === playerId) {
                    createConfetti();
                }
            }
            
            // Update scores in database
            roomRef.child('players').update({
                [playerIds[0]]: {
                    ...players[playerIds[0]],
                    score: playerScores[playerIds[0]]
                },
                [playerIds[1]]: {
                    ...players[playerIds[1]],
                    score: playerScores[playerIds[1]]
                }
            });
            
            // Check if game is over
            if (currentRound >= maxRounds) {
                setTimeout(() => {
                    endGame();
                }, 2000);
            } else {
                // Enable rematch button
                setTimeout(() => {
                    rematchSection.classList.remove('hidden');
                }, 1000);
            }
        }
        
        // Update player stats in Firebase
        function updatePlayerStats() {
            const statsRef = database.ref(`playerStats/${playerId}`);
            statsRef.set(playerStats);
        }
        
        // Fungsi untuk membuat efek confetti
        function createConfetti() {
            const colors = ['#4361ee', '#3f37c9', '#4895ef', '#4cc9f0', '#f72585'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = `${Math.random() * 10 + 5}px`;
                confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
                
                document.body.appendChild(confetti);
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }
        
        // Fungsi untuk meminta rematch
        function requestRematch() {
            playSound('click');
            rematchRequested = true;
            roomRef.update({
                rematchRequested: true,
                rematchAccepted: false
            });
            
            rematchButton.disabled = true;
            rematchButton.innerHTML = 'Menunggu lawan <span class="rematch-pending">...</span>';
        }
        
        // Fungsi untuk menerima permintaan rematch
        function acceptRematchRequest() {
            playSound('click');
            roomRef.update({
                rematchAccepted: true
            });
            rematchRequest.style.display = 'none';
        }
        
        // Fungsi untuk menolak permintaan rematch
        function declineRematchRequest() {
            playSound('click');
            rematchRequest.style.display = 'none';
        }
        
        // Fungsi untuk memulai rematch
        function startRematch() {
            playSound('click');
            
            // Reset game state
            playerScores[playerIds[0]] = 0;
            playerScores[playerIds[1]] = 0;
            rematchRequested = false;
            opponentRematchStatus = false;
            
            // Update Firebase
            roomRef.update({
                gameState: 'playing',
                currentRound: 1,
                'players/player1/choice': null,
                'players/player1/ready': false,
                'players/player1/score': 0,
                'players/player2/choice': null,
                'players/player2/ready': false,
                'players/player2/score': 0,
                rematchRequested: false,
                rematchAccepted: false
            });
            
            // Reset UI
            player1Choice.textContent = '‚ùì';
            player2Choice.textContent = '‚ùì';
            player2Choice.classList.add('hidden-choice');
            gameStatus.textContent = 'Pilih batu, gunting, atau kertas!';
            rematchButton.disabled = false;
            rematchButton.innerHTML = '<span>üîÑ</span> Main Lagi';
            rematchRequest.style.display = 'none';
            rematchSection.classList.add('hidden');
            
            // Enable choices
            choices.forEach(c => {
                c.classList.remove('selected');
                c.style.pointerEvents = 'auto';
            });
        }
        
        // Fungsi untuk keluar dari game
        function quitGame() {
            playSound('click');
            roomRef.child(`players/${playerId}`).remove().then(() => {
                resetGame();
            });
        }
        
        // Fungsi untuk mengakhiri game
        function endGame() {
            roomRef.update({
                gameState: 'finished'
            });
        }
        
        // Fungsi untuk menampilkan hasil akhir game
        function showGameResult() {
            gameArea.classList.add('hidden');
            gameResult.classList.remove('hidden');
            
            roomRef.child('players').once('value').then(snapshot => {
                const players = snapshot.val();
                playerIds = Object.keys(players);
                
                // Update final scores
                document.getElementById('finalPlayer1Name').textContent = players[playerIds[0]].name;
                document.getElementById('finalPlayer2Name').textContent = players[playerIds[1]].name;
                
                document.getElementById('finalPlayer1Level').textContent = `Level ${players[playerIds[0]].level || 1}`;
                document.getElementById('finalPlayer2Level').textContent = `Level ${players[playerIds[1]].level || 1}`;
                
                document.getElementById('finalPlayer1Score').textContent = `Skor: ${players[playerIds[0]].score}`;
                document.getElementById('finalPlayer2Score').textContent = `Skor: ${players[playerIds[1]].score}`;
                
                // Determine winner
                if (players[playerIds[0]].score > players[playerIds[1]].score) {
                    resultText.textContent = `üéâ ${players[playerIds[0]].name} Menang Game! üéâ`;
                    document.getElementById('finalPlayer1Card').classList.add('winner');
                    
                    if (playerId === playerIds[0]) {
                        createConfetti();
                        playSound('win');
                    }
                } else if (players[playerIds[0]].score < players[playerIds[1]].score) {
                    resultText.textContent = `üéâ ${players[playerIds[1]].name} Menang Game! üéâ`;
                    document.getElementById('finalPlayer2Card').classList.add('winner');
                    
                    if (playerId === playerIds[1]) {
                        createConfetti();
                        playSound('win');
                    }
                } else {
                    resultText.textContent = "Game Seri! ü§ù";
                    playSound('draw');
                }
            });
        }
        
        // Fungsi untuk reset game dan kembali ke menu awal
        function resetGame() {
            // Reset UI
            gameResult.classList.add('hidden');
            gameArea.classList.add('hidden');
            waitingRoom.classList.add('hidden');
            tournamentScreen.classList.add('hidden');
            leaderboardScreen.classList.add('hidden');
            gameSetup.classList.remove('hidden');
            
            // Reset state
            playerId = null;
            roomId = null;
            playerNames = {};
            playerChoices = {};
            playerScores = {};
            isHost = false;
            gameStarted = false;
            currentRound = 0;
            rematchRequested = false;
            opponentRematchStatus = false;
            
            // Reset input
            playerNameInput.value = '';
            roomIdInput.value = '';
            
            // Reset choices
            choices.forEach(c => {
                c.classList.remove('selected');
                c.style.pointerEvents = 'auto';
            });
            
            // Remove all confetti
            document.querySelectorAll('.confetti').forEach(el => el.remove());
            
            // Reset rematch UI
            rematchButton.disabled = false;
            rematchButton.innerHTML = '<span>üîÑ</span> Main Lagi';
            rematchRequest.style.display = 'none';
            rematchSection.classList.add('hidden');
        }
        
        // Fungsi untuk update daftar pemain di waiting room
        function updatePlayerList(players) {
            playerList.innerHTML = '';
            
            for (const [id, player] of Object.entries(players)) {
                const playerElement = document.createElement('div');
                playerElement.className = 'player-item';
                
                const avatar = document.createElement('img');
                avatar.src = player.profilePic || "https://via.placeholder.com/30";
                avatar.style.width = "30px";
                avatar.style.height = "30px";
                avatar.style.borderRadius = "50%";
                avatar.style.marginRight = "10px";
                
                const name = document.createElement('span');
                name.textContent = player.name;
                
                if (id === playerId) {
                    name.innerHTML += ' <strong>(Anda)</strong>';
                }
                
                playerElement.appendChild(avatar);
                playerElement.appendChild(name);
                playerList.appendChild(playerElement);
            }
        }
        
        // Fungsi untuk menyalin ID Room
        function copyRoomId() {
            playSound('click');
            navigator.clipboard.writeText(roomId).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                copyBtn.textContent = '‚úì';
                setTimeout(() => {
                    copyBtn.textContent = '‚éò';
                }, 2000);
            });
        }
        
        // Fungsi untuk menampilkan error
        function showError(message) {
            const errorEl = document.createElement('div');
            errorEl.style.color = 'red';
            errorEl.style.marginTop = '10px';
            errorEl.textContent = message;
            
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            errorEl.className = 'error-message';
            joinRoomBtn.parentNode.insertBefore(errorEl, joinRoomBtn.nextSibling);
            
            // Animasi shake pada tombol
            joinRoomBtn.classList.add('shake');
            setTimeout(() => {
                joinRoomBtn.classList.remove('shake');
            }, 500);
        }
        
        // Fungsi untuk menampilkan turnamen
        function showTournaments() {
            playSound('click');
            gameSetup.classList.add('hidden');
            tournamentScreen.classList.remove('hidden');
            renderTournaments();
        }
        
        // Fungsi untuk merender daftar turnamen
        function renderTournaments() {
            const container = document.getElementById('tournamentList');
            container.innerHTML = '';
            
            tournamentData.forEach(tournament => {
                const card = document.createElement('div');
                card.className = 'tournament-card';
                card.innerHTML = `
                    <div class="tournament-level">${tournament.name}</div>
                    <div>Hadiah: ${tournament.prize}</div>
                    <div>Peserta: ${tournament.participants}</div>
                    ${playerStats.xp >= tournament.requiredXP ? 
                        '<button class="btn btn-sm btn-primary" style="margin-top: 10px;">Ikuti</button>' : 
                        `<div style="color: var(--danger); margin-top: 10px;">Butuh ${tournament.requiredXP - playerStats.xp} XP lagi (Level ${tournament.level})</div>`}
                `;
                
                if (playerStats.xp >= tournament.requiredXP) {
                    card.querySelector('button').addEventListener('click', () => joinTournament(tournament));
                }
                
                container.appendChild(card);
            });
        }
        
        // Fungsi untuk bergabung dengan turnamen
        function joinTournament(tournament) {
            playSound('click');
            currentTournament = tournament;
            alert(`Anda bergabung dengan ${tournament.name}!`);
            // Here you would normally implement tournament logic
            // For now we'll just go back to main screen
            tournamentScreen.classList.add('hidden');
            gameSetup.classList.remove('hidden');
        }
        
        // Fungsi untuk menampilkan leaderboard
        function showLeaderboard() {
            playSound('click');
            
            // In a real app, you would fetch this from Firebase
            const sampleData = [
                { name: "Player 1", level: 15, score: 12500, profilePic: "https://via.placeholder.com/40" },
                { name: "Player 2", level: 12, score: 9800, profilePic: "https://via.placeholder.com/40" },
                { name: playerNameInput.value || "Anda", level: playerStats.level, score: playerStats.xp, profilePic: playerProfilePic },
                { name: "Player 3", level: 10, score: 7500, profilePic: "https://via.placeholder.com/40" },
                { name: "Player 4", level: 8, score: 6200, profilePic: "https://via.placeholder.com/40" }
            ];
            
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';
            
            sampleData.sort((a, b) => b.score - a.score).forEach((player, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index < 3 ? `<span class="rank-badge">${index + 1}</span>` : index + 1}</td>
                    <td><img src="${player.profilePic}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;">${player.name}</td>
                    <td>${player.level}</td>
                    <td>${player.score}</td>
                `;
                tbody.appendChild(row);
            });
            
            gameArea.classList.add('hidden');
            gameResult.classList.add('hidden');
            leaderboardScreen.classList.remove('hidden');
        }
        
        // Fungsi untuk kembali ke menu utama
        function backToMain() {
            playSound('click');
            tournamentScreen.classList.add('hidden');
            gameSetup.classList.remove('hidden');
        }
        
        // Fungsi untuk kembali dari leaderboard
        function backFromLeaderboard() {
            playSound('click');
            leaderboardScreen.classList.add('hidden');
            
            if (gameStarted) {
                gameArea.classList.remove('hidden');
            } else if (gameResult.classList.contains('hidden')) {
                gameSetup.classList.remove('hidden');
            } else {
                gameResult.classList.remove('hidden');
            }
        }
        
        // Fungsi untuk toggle sound
        function toggleSound() {
            soundEnabled = !soundEnabled;
            this.textContent = soundEnabled ? 'üîä' : 'üîá';
            playSound('click');
            
            if (soundEnabled) {
                sounds.background.loop = true;
                sounds.background.volume = 0.3;
                sounds.background.play().catch(e => console.log("Background audio play failed:", e));
            } else {
                sounds.background.pause();
            }
        }
        
        // Fungsi untuk handle profile picture upload
        function handleProfileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    playerProfilePic = event.target.result;
                    document.getElementById('profilePreview').src = playerProfilePic;
                    playSound('click');
                }
                reader.readAsDataURL(file);
            }
        }
        
        // Helper function untuk generate random ID
        function generateId() {
            return Math.random().toString(36).substr(2, 6);
        }
        
        // Initialize the game
        window.onload = function() {
            initTournaments();
            
            // Start background music
            sounds.background.loop = true;
            sounds.background.volume = 0.3;
            sounds.background.play().catch(e => console.log("Background audio play failed:", e));
            
            // Load player stats from Firebase if available
            const savedName = localStorage.getItem('playerName');
            if (savedName) {
                playerNameInput.value = savedName;
            }
            
            const savedStats = localStorage.getItem('playerStats');
            if (savedStats) {
                playerStats = JSON.parse(savedStats);
            }
        };
    </script>
</body>
</html>